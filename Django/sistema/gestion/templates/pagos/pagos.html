{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>Pagos</title>

    <link rel="stylesheet" href="{% static 'css/tablas_pagos.css' %}">

</head>
<body>
    <h1>Hola, {{ user.nombre }} 👋</h1>
    <p>Bienvenido a la sección de Pagos.</p>
    <br><br>

    <a href="{% url 'logout' %}" class="btn btn-secondary" style="color: red;">Cerrar Sesión</a>

    <form method="post">
        {% csrf_token %}
        <div>
            <label for="cuenta_bancaria">cuenta bancaria:</label>
            <select id="cuenta_bancaria" name="cuenta_bancaria">
                <option value="">Seleccione una cuenta</option>
                {% for cuenta in cuentas_bancarias %}
                    <option value="{{ cuenta.id }}" 
                            data-num-cuenta="{{ cuenta.num_cuenta }}" 
                            data-saldo="{{ cuenta.saldo }}">
                        {{ cuenta.banco }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <br>
        <div>
            <label>Número de Cuenta:</label>
            <span id="num_cuenta">--</span>
        </div>
        <div>
            <label>Saldo: $</label>
            <span id="saldo">--</span>
        </div>
        <br>
    </form>
    
    <script>
        document.getElementById('cuenta_bancaria').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const numCuenta = selectedOption.getAttribute('data-num-cuenta');
            const saldo = selectedOption.getAttribute('data-saldo');
            
            document.getElementById('num_cuenta').textContent = numCuenta || '--';
            document.getElementById('saldo').textContent = saldo || '--';
        });
    </script>

    <div class="d-flex justify-content-end mt-3">
        <a href="{% url 'mostrar_detalle_pagos' %}" class="btn btn-success me-2">
            Mostrar Pagos
        </a>
        <button id="btn-pagar" class="btn btn-primary me-2" disabled>Pagar</button>
        <button id="btn-pagar-todo" class="btn btn-primary" disabled>Pagar Todo</button>
    </div>

    <h2>Lista de Pagos</h2>
    <div class="tabla-container">
        <div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Descripción del Gasto</th>
                            <th>Monto</th>
                            <th>Fecha de Registro</th>
                            <th>Fecha de Limite</th>
                            <th>Estado del Gasto</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pago in pagos %}
                            {% if pago.gasto.estado != "Aprobado" %}
                                <tr>
                                    <td>{{ pago.gasto.descripcion }}</td>
                                    <td>${{ pago.gasto.monto }}</td>
                                    <td>{{ pago.gasto.fecha_registro|date:"d/m/Y" }}</td>
                                    <td>{{ pago.gasto.fecha_limite|date:"d/m/Y" }}</td>
                                    <td>
                                        {% if pago.gasto.estado in 'Cancelado,Rechazado' %}
                                            <span title="{{ pago.gasto.motivo_cancelacion }}">{{ pago.gasto.estado }}</span>
                                        {% else %}
                                            {{ pago.gasto.estado }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if pago.gasto.estado == "Pendiente" %}
                                            <button class="btn btn-danger rechazar-pago-btn" data-pago-id="{{ pago.id }}">Rechazar</button>
                                            <button class="btn btn-success validar-pago-btn" data-pago-id="{{ pago.id }}">Validar</button>
                                        {% elif pago.gasto.estado == "Aprobado" %}
                                            <button class="btn btn-warning btn-cancelar-pago" 
                                                data-id="{{ pago.id }}" 
                                                data-descripcion="{{ pago.gasto.descripcion }}">
                                                Cancelar
                                            </button>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endif %}
                        {% empty %}
                            <tr>
                                <td colspan="6" class="text-center">No hay pagos cancelados o rechazados.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tabla de Pagos Aprobados -->
        <div>
            <h2>Pagos Aprobados</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Seleccionar</th>
                            <th>Descripción del Gasto</th>
                            <th>Monto</th>
                            <th>Fecha de Registro</th>
                            <th>Fecha de Limite</th>
                            <th>Estado del Gasto</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pago in pagos %}
                            {% if pago.gasto.estado == "Aprobado" %}
                                <tr>
                                    <td>
                                        <!-- Checkbox con el ID del pago -->
                                        <input type="checkbox" class="select-pago" name="selected_pagos" value="{{ pago.id }}">
                                    </td>
                                    <td>{{ pago.gasto.descripcion }}</td>
                                    <td>${{ pago.gasto.monto }}</td>
                                    <td>{{ pago.gasto.fecha_registro|date:"d/m/Y" }}</td>
                                    <td>{{ pago.gasto.fecha_limite|date:"d/m/Y" }}</td>
                                    <td>{{ pago.gasto.estado }}</td>
                                    <td>
                                        {% if pago.gasto.estado == "Pendiente" %}
                                            <button class="btn btn-danger rechazar-pago-btn" data-pago-id="{{ pago.id }}">Rechazar</button>
                                            <button class="btn btn-success validar-pago-btn" data-pago-id="{{ pago.id }}">Validar</button>
                                        {% elif pago.gasto.estado == "Aprobado" %}
                                            <button class="btn btn-warning btn-cancelar-pago" 
                                                data-id="{{ pago.id }}" 
                                                data-descripcion="{{ pago.gasto.descripcion }}">
                                                Cancelar
                                            </button>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endif %}
                        {% empty %}
                            <tr>
                                <td colspan="6" class="text-center">No hay pagos aprobados.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</body>

    <!-- Modal de Cancelación -->
{% include 'pagos/modal_cancel_pago.html' %}
    
    <!-- Modal de Confirmación -->
{% include 'pagos/modal_confirm_pago.html' %}

<div class="modal fade" id="confirmarModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalLabel">Confirmación de Pagos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Seguro que quiere realizar los siguientes pagos?</p>
                <ul id="pagos-lista">
                    <!-- Aquí se llenarán los pagos seleccionados dinámicamente -->
                </ul>
            </div>
            <p><strong>Total a pagar:</strong> $<span id="total-pagos-modal">0.00</span></p>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btn-pagar-confirmado">Pagar</button>
            </div>
        </div>
    </div>
</div>
<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    $(document).ready(function () {
        let pagoId = null;
        let actionUrl = null;

        // Inicializar modales de Bootstrap
        const modalConfirmacion = new bootstrap.Modal(document.getElementById('confirmModal'));
        const modalCancelacion = new bootstrap.Modal(document.getElementById('cancelarModal'));

        // Función para actualizar el estado, agregar el botón de cancelar y ocultar botones después de la acción
        function actualizarEstadoPago() {
            const row = $(`button[data-pago-id="${pagoId}"]`).closest('tr');
            row.find('.estado-pago').text('Aprobado');
            row.find('.validar-pago-btn').remove(); // Remueve el botón de "Validar"
            row.find('.rechazar-pago-btn').remove(); // Remueve el botón de "Rechazar"

            // Añadir el botón de "Cancelar"
            const cancelarBtn = `<button class="btn btn-warning btn-cancelar-pago" data-id="${pagoId}" data-descripcion="Descripción del gasto">Cancelar</button>`;
            row.find('td:last').append(cancelarBtn);  // Agrega el botón de "Cancelar" en la última columna
        }

        // Confirmar Validación (Botón "Validar")
        $(document).on('click', '.validar-pago-btn', function () {
            pagoId = $(this).data('pago-id');
            $('#confirmar-validacion').data('action', 'validar');
            modalConfirmacion.show();
        });

        // Confirmar Cancelación/Rechazo (Botón "Cancelar" o "Rechazar")
        $(document).on('click', '.btn-cancelar-pago, .rechazar-pago-btn', function () {
            pagoId = $(this).data('id') || $(this).data('pago-id');
            const descripcion = $(this).data('descripcion');
            const isRechazar = $(this).hasClass('rechazar-pago-btn');
            
            $('#motivo_cancelacion').val("");

            // Definir título y acción según el botón
            const modalTitle = isRechazar ? "Rechazar Pago" : "Cancelar Pago";
            const modalAction = isRechazar ? `/pagos/rechazar/${pagoId}/` : `/cancelar_pago/${pagoId}/`;
            actionUrl = modalAction;

            $('#cancelarModalLabel').text(modalTitle);
            $('#modalDescripcion').text(descripcion || "");
            $('#cancelarPagoForm').attr('action', actionUrl);
            modalCancelacion.show();
        });

        // Enviar el formulario de cancelación/rechazo
        $('#cancelarPagoForm').on('submit', function (e) {
            e.preventDefault();

            const motivo = $('#motivo_cancelacion').val();

            $.ajax({
                url: actionUrl,
                type: 'POST',
                data: {
                    motivo_cancelacion: motivo,
                    csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val()
                },
                success: function (response) {
                    if (response.success) {
                        alert(response.message);
                        const row = $(`button[data-id="${pagoId}"], button[data-pago-id="${pagoId}"]`).closest('tr');
                        row.find('.estado-pago').text(response.new_state || 'Actualizado');
                        row.find('.btn-cancelar-pago, .rechazar-pago-btn').remove();
                        row.find('.validar-pago-btn').remove();
                        modalCancelacion.hide();
                        window.location.reload();
                    } else {
                        alert(response.message);
                    }
                },
                error: function () {
                    alert('Ocurrió un error. Inténtalo nuevamente.');
                }
            });
        });

        // Confirmar Validación (Aceptar en el modal de confirmación)
        $('#confirmar-validacion').on('click', function () {
            if (pagoId && $(this).data('action') === 'validar') {
                const url = "{% url 'validar_pago' 0 %}".replace('0', pagoId);

                $.ajax({
                    url: url,
                    type: 'POST',
                    headers: { "X-CSRFToken": "{{ csrf_token }}" },
                    success: function (response) {
                        if (response.success) {
                            alert(response.message);
                            window.location.reload();
                            actualizarEstadoPago();
                            modalConfirmacion.hide();
                        } else {
                            alert(response.message);
                        }
                    },
                    error: function () {
                        alert('Ocurrió un error. Por favor, inténtalo nuevamente.');
                    }
                });
            }
        });

        // Restablecer pagoId cuando se cierre el modal de confirmación
        modalConfirmacion._element.addEventListener('hidden.bs.modal', function () {
            pagoId = null;
        });

        // Restablecer pagoId cuando se cierre el modal de cancelación
        modalCancelacion._element.addEventListener('hidden.bs.modal', function () {
            pagoId = null;
        });
    });

    $(document).ready(function () {
    // Selecciona el botón de pagar
    const btnPagar = $('#btn-pagar');

    // Evento al cambiar el estado de los checkboxes
    $('.select-pago').on('change', function () {
        // Verifica si hay al menos un checkbox marcado
        const haySeleccionado = $('.select-pago:checked').length > 0;

        // Habilita o deshabilita el botón según la selección
        if (haySeleccionado) {
            btnPagar.prop('disabled', false);
        } else {
            btnPagar.prop('disabled', true);
        }
    });
});
</script>

<script>
$(document).ready(function () {
    // Utilizamos una sola instancia de modal
    const modalConfirmacion = new bootstrap.Modal(document.getElementById('confirmarModal'));
    const btnPagar = $('#btn-pagar');
    const btnPagarTodo = $('#btn-pagar-todo');
    const pagosLista = $('#pagos-lista');
    const totalPagosModal = $('#total-pagos-modal');
    const btnCancelarModal = $('#btn-cancelar');
    let totalPagos = 0;
    let pagosSeleccionados = [];

    // Habilitar "Pagar Todo" si hay pagos aprobados
    const habilitarPagarTodo = function () {
        const pagosAprobados = $('.select-pago').length;
        btnPagarTodo.prop('disabled', pagosAprobados === 0);
    };
    habilitarPagarTodo();

    // Función común para manejar la lista y total de pagos
    const mostrarPagosEnModal = function () {
        pagosLista.empty();
        totalPagos = 0;

        pagosSeleccionados.forEach(pagoId => {
            const pagoDescripcion = $(`input[value="${pagoId}"]`).closest('tr').find('td').eq(1).text();
            const pagoMonto = parseFloat(
                $(`input[value="${pagoId}"]`).closest('tr').find('td').eq(2).text().replace('$', '').replace(',', '')
            );
            pagosLista.append(`<li>${pagoDescripcion} - $${pagoMonto.toFixed(2)}</li>`);
            totalPagos += pagoMonto;
        });

        totalPagosModal.text(totalPagos.toFixed(2));
        modalConfirmacion.show();
    };

    // Evento para abrir el modal de confirmación cuando se hace clic en "Pagar"
    btnPagar.on('click', function () {
        pagosSeleccionados = $('.select-pago:checked').map(function () {
            return $(this).val();
        }).get();
        mostrarPagosEnModal();
    });

    // Evento para "Pagar Todo"
    btnPagarTodo.on('click', function () {
        pagosSeleccionados = $('.select-pago').map(function () {
            return $(this).val();
        }).get();
        mostrarPagosEnModal();
    });

    // Evento para el botón de "Cancelar" en el modal
    btnCancelarModal.on('click', function () {
        modalConfirmacion.hide();
    });

    // Confirmar pago
    $('#btn-pagar-confirmado').on('click', function () {
        const cuentaBancariaId = $('#cuenta_bancaria').val();
        if (!cuentaBancariaId) {
            alert('Por favor, seleccione una cuenta bancaria.');
            return;
        }

        // Realizar la solicitud AJAX para procesar los pagos seleccionados
        $.ajax({
            url: "/pagar_multiple/",
            type: 'POST',
            data: {
                pagos_ids: pagosSeleccionados,
                cuenta_bancaria: cuentaBancariaId,
                csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val()
            },
            success: function (response) {
                if (response.success) {
                    alert('Pagos procesados exitosamente.');
                    pagosSeleccionados.forEach(pagoId => {
                        const row = $(`input[value="${pagoId}"]`).closest('tr');
                        row.find('td').eq(5).text('Pagado');
                        row.remove(); // Eliminar la fila de la tabla
                    });
                    modalConfirmacion.hide();
                    habilitarPagarTodo(); // Deshabilitar "Pagar Todo" si no quedan pagos
                } else {
                    alert(response.message);
                }
            },
            error: function () {
                alert('Ocurrió un error al procesar los pagos. Inténtalo nuevamente.');
            }
        });
    });
});

</script>
</html>
